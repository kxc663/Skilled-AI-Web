<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Test Page</title>
  <link rel="stylesheet" href="./css/test_style.css">
  <script src="./jquery-3.6.1.min.js"></script>
</head>

<body>
  <h1>Test</h1>
  <button id="back" onclick="back()">Back</button>
  <div class="testPage">
    <div class="leftpart">
      <div class="test-box" id="imgBox" onmousedown="selectAnswer(event)">
        <img id="pic1" class="test-img" src="./img/broken_cylinder_1.png" alt="" width="960px" />
        <canvas id="myCanvas" width="960" height="960"></canvas>
      </div>
      <div class="Zoom">
        <button id="zoom_In" onclick="zoomIn()" disabled>Zoom In</button>
        <button id="move_Btn" onclick="move()">Move</button>
        <button id="zoom_Out" onclick="zoomOut()" disabled>Zoom Out</button>
      </div>
      <div class="addNew">
        <button id="addNew_Btn" onclick="addNew()">Add New</button>

      </div>
    </div>
    <div class="rightpart">
      <div class="answer" id="answerDiv"> Answer:</div>
      <div id="confidence"> Confidence:
        <div class="slidecontainer">
          <input type="range" class="slider" id="conf_slider" min="0" max="100" step="10" onchange="sliderChange()" />
          <div id="conf_value"> 50% </div>
          <button id="confidence_Btn" onclick="confirmAns()">Confirm</button>
        </div>
      </div>
      <div class="submit">
        <button id="submit_Btn">submit</button>
      </div>
    </div>
  </div>
</body>

</html>


<script>
  /*
  b.value=this.value+'%'
    var imageZoom = {
      
      init: function () {
        this.zoomImage();
      },
  
      zoomImage: function () {
        
        var _this = this;
        $(".test-box").off("mousewheel").on("mousewheel", ".test-img", function (e) {
          _this.mouseScroll($(this));
        });
      },
  
      mouseScroll: function ($img, e) {
        var e = e || window.event;
        var oper = Math.max(-1, Math.min(1, (e.wheelDelta || -e.originalEvent.detail)));
        var newWidth = Math.max(350, Math.min(12000, $img.width() + (30 * oper)));
        if (newWidth >= 1500) {
          newWidth = 1500;
        } else if (newWidth <= 960) {
          newWidth = 960;
        }
        $img.css({
          "width": newWidth + "px",
        })
  
        
      },
    };
  
      window.onload = function () {
      for (i = 0; i < 50; i++) {
        var x = document.createElement("div");
        x.innerHTML = "test<br/>";
      }
      function $(x) {
        return document.getElementById(x);
      };
      $("wrap").onmousewheel = function scrollWheel(e) {
        var sl;
        e = e || window.event;
        e.preventDefault();
      };
    }
    imageZoom.init();
  */
  //***********************************image drag******************************************************************************
  var canDrag = false;
  var imageDrag = function () {
    var isDrag = false;

    var dragTarget;
    var startX, startY;
    var imgPositionTop, imgPositionLeft;
    var boxWidthMin, boxWidthMax, boxHeightMin, boxHeightMax;
    function moveMouse(e) {
      if (isDrag && canDrag) {
        var e = window.event || e;
        var clientY = e.clientY;
        var clientX = e.clientX;
        if (clientY >= boxHeightMin && clientY <= boxHeightMax) {
          dragTarget.style.top = imgPositionTop + clientY - startY + "px";
        }
        if (clientX >= boxWidthMin && clientX <= boxWidthMax) {
          dragTarget.style.left = imgPositionLeft + clientX - startX + "px";
        }
        return false;
      }
    }

    function initDrag(e) {
      var e = window.event || e;
      var dragHandle = e.srcElement;
      var topElement = "HTML";
      var eventBtn = e.button == 0 || e.button == 1;

      while (dragHandle.tagName != topElement && dragHandle.className != "test-img") {
        dragHandle = dragHandle.parentElement;
      }
      if (dragHandle.className == "test-img" && eventBtn) {
        isDrag = true;
        dragTarget = dragHandle;
        imgPositionTop = parseInt(dragTarget.style.top + 0);
        startY = e.clientY;
        imgPositionLeft = parseInt(dragTarget.style.left + 0);
        startX = e.clientX;

        var initVal = 50;
        var $box = $(".test-box");
        boxWidthMin = $box.offset().left + initVal;
        boxWidthMax = $box.offset().left + $box.width() - initVal;
        boxHeightMin = $box.offset().top + initVal;
        boxHeightMax = $box.offset().top + $box.height() - initVal;

        $(document).unbind("mousemove").bind("mousemove", moveMouse);
        return false;
      }
    }

    $(document).unbind("mousedown").bind("mousedown", initDrag);
    $(document).unbind("mouseup").bind("mouseup", function () {
      isDrag = false;
    });
  };
  imageDrag();
  //***************************************************************************************************************************

  //***********************************Zoom************************************************************************************
  function zoomIn() {
    document.getElementById("myCanvas").style.visibility = "hidden";
    var pic = document.getElementById("pic1");
    var currentWidth = pic.clientWidth;
    if (currentWidth <= 1500) {
      pic.style.width = currentWidth + 50 + "px";
    } else {
      return false;
    }
  }

  function zoomOut() {
    document.getElementById("myCanvas").style.visibility = "hidden";
    var pic = document.getElementById("pic1");
    var currentWidth = pic.clientWidth;

    if (currentWidth >= 960) {
      pic.style.width = currentWidth - 50 + "px";
    } else {
      return false;
    }
  }

  function move() {
    document.getElementById("myCanvas").style.visibility = "hidden";
    document.getElementById("zoom_In").disabled = false;
    document.getElementById("zoom_Out").disabled = false;
    canDraw == false;
    canDrag = true;
  }
  //***************************************************************************************************************************

  //***********************************draw************************************************************************************
  var canDraw = false;
  function addNew() {
    var pic = document.getElementById("pic1");
    pic.style.width = "960px";
    pic.style.top = "0px";
    pic.style.left = "0px";
    document.getElementById("addNew_Btn").disabled = true;
    document.getElementById("move_Btn").disabled = true;
    document.getElementById("myCanvas").style.visibility = "visible";
    canDraw = true;
  }

  function selectAnswer(e) {
    if (canDraw == true) {
      var pic = document.getElementById("myCanvas");
      ansX = e.clientX - 8;
      ansY = e.clientY - 130;
      Draw(ansX, ansY);
    }
  }

  function Draw(x, y) {
    var img = document.getElementById("pic1");
    var cnvs = document.getElementById("myCanvas");
    cnvs.style.position = "absolute";
    cnvs.style.left = img.left + "px";
    cnvs.style.top = img.top + "px";
    var ctx = cnvs.getContext("2d");
    ctx.beginPath();
    ctx.arc(x, y, 20, 0, 3 * Math.PI, false);
    ctx.lineWidth = 3;
    ctx.strokeStyle = "red";
    ctx.stroke();
    document.getElementById("confidence").style.visibility = "visible";
    canDraw = false;
  }
  //***************************************************************************************************************************
  var conf = 50;
  function sliderChange(){
    conf = document.getElementById("conf_slider").value;
    document.getElementById("conf_value").innerHTML = conf + "%";
  }
  //***********************************answer zone*****************************************************************************
  var ansX;
  var ansY;
  var index = 0;
  var testerMap = new Map(); //(order, x, y, conf, del?)
  // change this line to change tester (still working on it)
  //var jsonStr = '{"Tester1":[{"AnswerOrd": 0, "X": 0, "Y": 0, "CONF": 0, "DEL": "TRUE"}]}';
  function confirmAns() {
    index++;
    //*********create answer field********************************
    document.getElementById("addNew_Btn").disabled = false;
    document.getElementById("confidence").style.visibility = "hidden";
    document.getElementById("move_Btn").disabled = false;
    const newAnswerLine = document.createElement("div");
    const newTextArea = document.createElement("div");
    const newBtn = document.createElement("button");
    newAnswerLine.setAttribute("id", "div_ans");
    newTextArea.setAttribute("id", "div_text");
    newBtn.setAttribute("class", "div_btn");
    newBtn.setAttribute("id", i.toString());
    document.getElementById("answerDiv").appendChild(newAnswerLine);
    newAnswerLine.appendChild(newTextArea);
    newTextArea.innerHTML += "position x: " + ansX + " " + "position y: " + ansY + " " + "confidence: " + conf + "%";
    newAnswerLine.appendChild(newBtn);
    //************************************************************

    //put answer into the map
    pushValue(testerMap, index, ansX, ansY, conf, "FALSE");
    console.log(testerMap);
    
    //*************delete answers*********************************
    newBtn.innerHTML = "Delete";
    newBtn.onclick = function () {
      var ord = this.id + "";
      var x = testerMap.get(ord)[0];
      var y = testerMap.get(ord)[1];
      var confident = testerMap.get(ord)[2];
      var change = testerMap.get(ord)[3];
      if (change=="FALSE"){
        pushValue(testerMap, this.id, x, y, confident, "TRUE");
      }
      console.log(testerMap);
      clearCanvas();
      for (var k = 1; k <= testerMap.size; k++){
        var order = k+"";
        var change1 = testerMap.get(order)[3];
        if(change1=="FALSE"){
          var x1 = testerMap.get(order)[0];
          var y1 = testerMap.get(order)[1];
          Draw(x1, y1);
        }
      }
      newAnswerLine.remove();
      //*********************************************************
    };
  }
  //***************************************************************************************************************************
  
  function pushValue(map, ord, x, y, confident, change){
    var order = ord + "";
    map.set(order, []);
    testerMap.get(order).push(x);
    testerMap.get(order).push(y);
    testerMap.get(order).push(confident);
    testerMap.get(order).push(change);
  }

  function clearCanvas(){
    var cnvs = document.getElementById("myCanvas");
    var ctx = cnvs.getContext("2d");
    ctx.clearRect(0, 0, cnvs.width, cnvs.height);  
  }
  function back(){
    
  }
</Script>